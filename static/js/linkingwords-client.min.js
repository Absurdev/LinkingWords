function getClassName(e){return classNames[e-1]?classNames[e-1]+" ("+e+")":e}function rememberFirstTime(e){"undefined"!=typeof Storage&&localStorage.setItem(e,!0)}function isFirstTime(e){return"undefined"!=typeof Storage?!localStorage.getItem(e):!1}function firstTimeToast(e,o,t,n,s){if(isFirstTime(o)){rememberFirstTime(o);var r=toastr.options.timeOut;return toastr.options.timeOut=n,toastr[e](t,s),toastr.options.timeOut=r,!0}return!1}function showBottleContainter(){return"undefined"==typeof Storage?!0:localStorage.getItem("peer-found")}function cachePublicInformation(e){for(var o in e)e.hasOwnProperty(o)&&(publicInformationCache[o]=e[o],publicInformationCache[o].connectionTime=parseInt(e[o].connectionTime))}function normalizeWord(e){return e.toLowerCase().trim()}function wordFrontEndValidation(e){var o=normalizeWord(e);return""===o?(toastr.warning("The word cannot be empty."),!1):o.length>maxWordLengthServerConfig?(toastr.warning("The word cannot be longer than "+maxWordLengthServerConfig+" characters."),!1):rawPendingWords[o]?(toastr.warning("This word is already in pending state."),!1):Object.keys(rawPendingWords).length>=maxPendingWordsServerConfig?(toastr.warning("You cannot have more than "+maxPendingWordsServerConfig+" pending words. Either remove some or wait for matches."),!1):!0}function bottleFrontEndValidation(e){var o=e.trim();return""===o?(toastr.warning("Message cannot be empty."),!1):o.length>maxMessageBottleLengthServerConfig?(toastr.warning("Message cannot be longer than "+maxMessageBottleLengthServerConfig+" characters."),!1):!0}function addNewPendingWordToView(e,o){$("#pending-words-container").css("display","block");var t=$("<li></li>").attr("class","pending-word").attr("data-word",e);t.append($("<div></div>").text(o)),t.append($("<div></div>").attr("class","pending-word-overlay").text("[X]")),$("#pending-words").append(t),rawPendingWords[e]=o}function removePendingWordFromView(e){"string"==typeof e&&(e=$("#pending-words").find('li[data-word="'+e+'"]').last()),e.fadeOut(100,function(){delete rawPendingWords[$(this).attr("data-word")],$(this).remove(),0===$("#pending-words li").length&&$("#pending-words-container").css("display","none")})}function getPicTooltip(e){var o=publicInformationCache[e],t=moment(o.connectionTime).fromNow(),n=[];return n.push("Hash: "+e),n.push("Connection: "+t),n.push("Class: "+getClassName(o["class"])),o["class"]<userClass&&e!==userIdHash&&n.push('<a href="#" onclick=\'requestPromotion("'+e+"\")'>Promote</a>"),n.join("<br>")}function requestPromotion(e){socket.emit("request-promotion",{userId:userId,userToPromoteHash:e})}function insertMessageFromUser(e,o){insertMessage(e,o,"right",userIdHash,chatPictureUser)}function insertMessageFromPeer(e,o,t){insertMessage(e,t,"left",o,publicInformationCache[o].chatPicture)}function insertMessage(e,o,t,n,s){var r,i,a=e.find(".messages"),c="message-box "+t+"-img";"left"===t?(r="right",i="tooltipster-green"):(r="left",i="tooltipster-blue"),a.loadTemplate("template/chat_message.html",{messageClass:c,message:o,chatPicture:s},{append:!0,beforeInsert:function(e){e.linkify(),e.find(".img").tooltipster({content:getPicTooltip.bind(this,n),theme:i,position:r,interactive:!0})},success:function(){a.scrollTop(a[0].scrollHeight)}})}function insertStatus(e,o){var t=e.find(".messages"),n=$("<div></div>").attr("class","chat-status").text(o).linkify();t.append(n),t.scrollTop(t[0].scrollHeight)}function notifyInWindowTitle(e){windowHasFocus||roomsWithPendingNotification[e]||(roomsWithPendingNotification[e]=!0,pendingNotifications++,document.title=["(",pendingNotifications,") Linking Words"].join(""))}function createNewChatWindow(e,o,t,n){$("#chat-windows-container").loadTemplate("template/chat_window.html",{roomName:e,title:o},{append:!0,success:function(){var o=GeoPattern.generate(t),s=$('[data-room-name="'+e+'"]');s.find(".header").css("background-image",o.toDataUrl()),s.find("a.send").css("background-image",o.toDataUrl()),n&&n(s)}})}function displayStatusAllRooms(e){$(".chat-window").each(function(){insertStatus($(this),e),notifyInWindowTitle($(this).attr("data-room-name"))})}var userId="-xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var o=16*Math.random()|0,t="x"==e?o:3&o|8;return t.toString(16)})+Date.now(),config=linkingwords.config,socket=io.connect(config.server+config.port,{query:"user_id="+userId}),userIdHash=md5(userId),chatPictureUser="X.Y.",userClass=1,windowHasFocus=!0,pendingNotifications=0,roomsWithPendingNotification={},publicInformationCache={},rawPendingWords={},maxWordLengthServerConfig=100,maxPendingWordsServerConfig=150,maxMessageBottleLengthServerConfig=1e4,classNames=[],userQuit=!1,quit=function(){userQuit||$.ajax({url:"/quit",type:"POST",async:!1,contentType:"application/json",data:JSON.stringify({userId:userId}),success:function(){userQuit=!0}})};$(window).on("beforeunload",function(){quit()}),$(window).unload(function(){quit()}),toastr.options.closeButton=!0,$(document).ready(function(){function e(e,o,t,n){$(window).width()<768?alertify.lwSmallScreenAlert(e,o):alertify.lwAlert(e,o).resizeTo(t+"px",n+"px")}var o="linkingwords.absurdev",t="gmail";$("#email").text(o+"@"+t+".com"),showBottleContainter()&&$("#bottle-container").show(),firstTimeToast("info","on-site","You can start by tossing a word.",5e3,"Welcome to Linking Words!"),$(window).focus(function(){document.title="Linking Words",pendingNotifications=0,roomsWithPendingNotification={},windowHasFocus=!0}).blur(function(){windowHasFocus=!1}),$("#chat-windows-container").on("click","a.send",function(e){var o=$(this).parents('div[class="chat-window"]'),t=o.attr("data-room-name"),n=o.find(".message-input"),s=n.val().trim();n.val("").focus(),s&&(socket.emit("chat-message",{userIdHash:userIdHash,roomName:t,message:s}),insertMessageFromUser(o,s)),e.stopPropagation()}),$("#shore-button").click($.debounce(1e3,!0,function(e){socket.emit("wander-shore",{userId:userId}),e.stopPropagation()})),$("#chat-windows-container").on("click",".chat-window",function(){$(this).find(".message-input").focus()}),$("#chat-windows-container").on("click","a.leave-room",function(e){var o=$(this).parents('div[class="chat-window"]'),t=o.attr("data-room-name");socket.emit("leave-room",{roomName:t,userId:userId}),o.remove(),e.stopPropagation()}),$("#chat-windows-container").on("keyup",".message-input",function(e){13===e.keyCode&&$(this).next().click()}),$("#toss-word-form").submit(function(e){var o=$("#word").val();return wordFrontEndValidation(o)?(addNewPendingWordToView(normalizeWord(o),o),socket.emit("word",{word:o,userId:userId}),$("#word").val("").focus(),!1):!1}),$("#seal-button").click(function(e){var o=$("#bottle-message").val();if(!bottleFrontEndValidation(o))return!1;var t={content:o};return socket.emit("cast-bottle",{bottle:t,userId:userId}),$("#bottle-message").val("").focus(),!1}),$("#pending-words").on("click","li.pending-word",function(){var e={word:$(this).attr("data-word"),userId:userId};socket.emit("remove-pending-word",e),removePendingWordFromView($(this))}),$("#stats-icon").click($.debounce(1e3,!0,function(){$("body").append('<div id="loading"></div>'),$.ajax({url:"api/v1/stats/ui",success:function(o){e("Stats",o,400,700)},error:function(){toastr.error("Failed to retrieve statistics from the server")},complete:function(){$("#loading").remove()}})})),$("#hiring-icon").click(function(){alertify.lwAlert("Hiring",$("#cheese-job").html())}),$("#quote-icon").click(function(){e("Collection de mots",$("#quote").html(),400,500)}),$("#nyaq-icon").click(function(){e("Not Yet Asked Questions",$("#nyaq").html(),600,600)})}),socket.on("word-data-validation-error",function(e){toastr.error(e)}),socket.on("word-string-validation-error",function(e){toastr.warning(e.message),removePendingWordFromView(e.word)}),socket.on("bottle-validation-error",function(e){toastr.warning(e)}),socket.on("server-error",function(e){toastr.error(e)}),socket.on("bottle-drifting-in-sea",function(){toastr.info("Your message now drifts away into the sea... Hope you'll get an answer!")}),socket.on("no-bottle-found",function(){toastr.info("Sorry but there was no bottle around...")}),socket.on("promotion-refused",function(e){toastr.warning(e)}),socket.on("promoted",function(e){userClass=e.value,toastr.success("Congratulations! You have been promoted to class '"+getClassName(userClass)+"' by "+e.userGrantingPromotion)}),socket.on("update-class-info",function(e){publicInformationCache[e.userIdHash]["class"]=e["class"]}),socket.on("promotion-accepted",function(e){toastr.success("You successfully promoted "+e.userPromotedHash+" to class "+getClassName(e.newClass))}),socket.on("class-names",function(e){classNames=e}),socket.on("peer-found",function(e){var o=rawPendingWords[e.word];removePendingWordFromView(e.word),cachePublicInformation(e.participants),createNewChatWindow(e.roomName,o,e.word),notifyInWindowTitle(e.roomName);var t=firstTimeToast("success","peer-found","We found a peer you can talk with! A good starting point is to share your common passion about this word...",8e3);t&&setTimeout(function(){$("#bottle-container").show(),firstTimeToast("success","bottle-container-shown","You can now throw a message in a bottle into the sea! Hopefully somebody will find it (otherwise it'd make you another despicable polluter).You can also look for bottles from others on the shore. Good luck!",12e3)},1e4)}),socket.on("bottle-found",function(e){var o=e.bottle,t=o.user===userIdHash;cachePublicInformation(e.participants),notifyInWindowTitle(e.roomName),createNewChatWindow(e.roomName,"Bottle "+o.id,o.content,function(n){t?(insertMessageFromUser(n,o.content),firstTimeToast("success","bottle-from-you-found","You're lucky! Somebody found your bottle...",6e3)):(insertMessageFromPeer(n,o.user,o.content),e.pull?firstTimeToast("success","bottle-from-other-found","Oh, while looking at the sand you found a message in a bottle, what does it say...",6e3):firstTimeToast("success","bottle-pushed","You stumbled upon a message in a bottle. I know you didn't ask for anything but ${quote_about_fate_here}...",7e3))})}),socket.on("word-validated",function(e){firstTimeToast("success","word-tossed","You word has been tossed. We'll work hard to connect you with somebody liking the same word.",8e3)}),socket.on("word-server-conf",function(e){maxPendingWordsServerConfig=e.maxPendingWordsPerUser||maxPendingWordsServerConfig,maxWordLengthServerConfig=e.maxWordLength||maxWordLengthServerConfig}),socket.on("bottle-server-conf",function(e){maxMessageBottleLengthServerConfig=e.maxMessageBottleLength||maxMessageBottleLengthServerConfig}),socket.on("chat-picture",function(e){chatPictureUser=e}),socket.on("chat-message",function(e){var o=$('[data-room-name="'+e.roomName+'"]');insertMessageFromPeer(o,e.sender,e.message),notifyInWindowTitle(e.roomName)}),socket.on("chat-status",function(e){var o=$('[data-room-name="'+e.roomName+'"]');insertStatus(o,e.message),notifyInWindowTitle(e.roomName)}),socket.on("master-message",function(e){"toastr"===e.type?toastr.info(e.message):"status"===e.type&&displayStatusAllRooms(e.message)});